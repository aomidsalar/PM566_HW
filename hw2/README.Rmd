---
title: "Assignment 2"
author: "Audrey Omidsalar"
date: "10/8/2021"
output:
  html_document:
    toc: yes
    toc_float: yes
    keep_md: yes
  github_document:
  always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library('data.table')
library('dtplyr')
library('dplyr')
```

## Download Data

```{r download data, cache = TRUE}
if (!file.exists("chs_individual.csv"))
  download.file(
    url = "https://raw.githubusercontent.com/USCbiostats/data-science-data/master/01_chs/chs_individual.csv",
    destfile = "chs_individual.csv",
    method   = "libcurl",
    timeout  = 60
  )
individual <- data.table::fread("chs_individual.csv")

if (!file.exists("chs_regional.csv"))
  download.file(
    url = "https://raw.githubusercontent.com/USCbiostats/data-science-data/master/01_chs/chs_regional.csv",
    destfile = "chs_regional.csv",
    method   = "libcurl",
    timeout  = 60
  )
regional <- data.table::fread("chs_regional.csv")
```

### Merge the Data
```{r merge}
merged <- merge(
  # Data
  x     = individual,      
  y     = regional, 
  by  = "townname",
  all.x = TRUE,      
  all.y = FALSE
)
```

### Check number of rows
```{r nrows}
dim(individual)
dim(regional)
dim(merged)
```
The `merged` dataset has 1200 rows, which is the same as the `individual` dataset.

### Looking at the `merged` dataset more closely
```{r summary}
summary(merged)
```

### Imputing missing variables
Some of the variables that will be used later have NA values. These will be replaced by the averages within the `hispanic` and `male` variables
```{r imputing}
merged[, bmi := fcoalesce(bmi, mean(bmi, na.rm = TRUE)),
    by = .(male, hispanic)]
merged[, fev := fcoalesce(fev, mean(fev, na.rm = TRUE)),
    by = .(male, hispanic)]
#merged[, smoke := fcoalesce(smoke, mean(smoke, na.rm = TRUE)),
#       by = .(male, hispanic)]
#merged[, gasstove := fcoalesce(gasstove, mean(gasstove, na.rm = TRUE)),
#       by = .(male, hispanic)]
```

### Creating new variable `obesity_level` 
```{r obesity-level}
merged[, obesity_level := fifelse(bmi < 14, "underweight",
                                  fifelse(bmi < 22, "normal",
                                        fifelse(bmi < 24, "overweight", "obese")))] 
##Summary Table
bmi_summary <- merged[, .(
  min_bmi = min(bmi),
  max_bmi = max(bmi),
  N_obs   = .N),
  by = "obesity_level"]
knitr::kable(bmi_summary)
```

### Creating new variable `smoke_gas_exposure`
```{r smoke-gas}
merged[, smoke_gas_exposure := fifelse(smoke == 0 & gasstove == 0, "no_exposure",
                                  fifelse(smoke == 0 & gasstove == 1, "gas_exposure",
                                        fifelse(smoke == 1 & gasstove == 0, "smoke_exposure",
                                                fifelse(smoke == 1 & gasstove == 1, "smoke_and_gas_exposure", "NA"))))] 
##Summary Table
smoke_gas_exposure_summary <- merged[, .(
  N_obs = .N),
  by = "smoke_gas_exposure"]
knitr::kable(smoke_gas_exposure_summary)
```

### Summary tables of Forced Expiratory Volume
```{r fev - town}
##By Town
merged[, .(
  fev_avg = mean(fev, na.rm = TRUE),
  fev_sd  = sd(fev, na.rm = TRUE),
  prop_asthma = sum(asthma == 1, na.rm = TRUE)/.N,
  prop_noasthma = sum(asthma == 0, na.rm = TRUE)/.N),
  by = "townname"] %>% knitr::kable(caption = "FEV by Town")
```
```{r fev - sex}
##By Sex
merged[, .(
  fev_avg = mean(fev, na.rm = TRUE),
  fev_sd  = sd(fev, na.rm = TRUE),
  prop_asthma = sum(asthma == 1, na.rm = TRUE)/.N,
  prop_noasthma = sum(asthma == 0, na.rm = TRUE)/.N),
  by = "male"] %>% knitr::kable(caption = "FEV by Sex")
```
```{r fev - obesity level}
##By Obesity Level
merged[, .(
  fev_avg = mean(fev, na.rm = TRUE),
  fev_sd  = sd(fev, na.rm = TRUE),
  prop_asthma = sum(asthma == 1, na.rm = TRUE)/.N,
  prop_noasthma = sum(asthma == 0, na.rm = TRUE)/.N),
  by = "obesity_level"] %>% knitr::kable(caption = "FEV by Obesity Level")
```
```{r fev - smokegas}
##By Town
merged[, .(
  fev_avg = mean(fev, na.rm = TRUE),
  fev_sd  = sd(fev, na.rm = TRUE),
  prop_asthma = sum(asthma == 1, na.rm = TRUE)/.N,
  prop_noasthma = sum(asthma == 0, na.rm = TRUE)/.N),
  by = "smoke_gas_exposure"] %>% knitr::kable(caption = "FEV by Smoke & Gas Exposure")

```


---
title: "Assignment 2"
author: "Audrey Omidsalar"
date: "10/8/2021"
output:
  html_document:
    toc: yes
    toc_float: yes
    keep_md: yes
  github_document:
  always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library('data.table')
library('dtplyr')
library('dplyr')
library('leaflet')
library('ggplot2')
```

## Download Data

```{r download data, cache = TRUE}
if (!file.exists("chs_individual.csv"))
  download.file(
    url = "https://raw.githubusercontent.com/USCbiostats/data-science-data/master/01_chs/chs_individual.csv",
    destfile = "chs_individual.csv",
    method   = "libcurl",
    timeout  = 60
  )
individual <- data.table::fread("chs_individual.csv")

if (!file.exists("chs_regional.csv"))
  download.file(
    url = "https://raw.githubusercontent.com/USCbiostats/data-science-data/master/01_chs/chs_regional.csv",
    destfile = "chs_regional.csv",
    method   = "libcurl",
    timeout  = 60
  )
regional <- data.table::fread("chs_regional.csv")
```

### Merge the Data
```{r merge}
merged <- merge(
  # Data
  x     = individual,      
  y     = regional, 
  by  = "townname",
  all.x = TRUE,      
  all.y = FALSE
)
```

### Check number of rows
```{r nrows}
dim(individual)
dim(regional)
dim(merged)
```
The `merged` dataset has 1200 rows, which is the same as the `individual` dataset.

### Looking at the `merged` dataset more closely
```{r summary}
summary(merged)
```

### Imputing missing variables
Some of the variables that will be used later have NA values. These will be replaced by the averages within the `hispanic` and `male` variables
```{r imputing}
merged[, bmi := fcoalesce(bmi, mean(bmi, na.rm = TRUE)),
    by = .(male, hispanic)]
merged[, fev := fcoalesce(fev, mean(fev, na.rm = TRUE)),
    by = .(male, hispanic)]
##keeping binary variables(smoke, gasstove), as it doesn't make sense to impute those
##adding male_ch variable to convert 0 to female and 1 to male
merged[, male_ch := fifelse(male == 0, "female", "male")]
```

### Creating new variable `obesity_level` 
```{r obesity-level}
merged[, obesity_level := fifelse(bmi < 14, "underweight",
                                  fifelse(bmi < 22, "normal",
                                        fifelse(bmi < 24, "overweight", "obese")))] 
##Summary Table
bmi_summary <- merged[, .(
  min_bmi = min(bmi),
  max_bmi = max(bmi),
  N_obs   = .N),
  by = "obesity_level"]
knitr::kable(bmi_summary)
```

### Creating new variable `smoke_gas_exposure`
```{r smoke-gas}
merged[, smoke_gas_exposure := fifelse(smoke == 0 & gasstove == 0, "no_exposure",
                                  fifelse(smoke == 0 & gasstove == 1, "gas_exposure",
                                        fifelse(smoke == 1 & gasstove == 0, "smoke_exposure",
                                                fifelse(smoke == 1 & gasstove == 1, "smoke_and_gas_exposure", "NA"))))] 
##Summary Table
smoke_gas_exposure_summary <- merged[, .(
  N_obs = .N),
  by = "smoke_gas_exposure"]
knitr::kable(smoke_gas_exposure_summary)
```

### Summary tables of Forced Expiratory Volume
```{r fev - town}
##By Town
merged[, .(
  fev_avg = mean(fev, na.rm = TRUE),
  fev_sd  = sd(fev, na.rm = TRUE),
  prop_asthma = sum(asthma == 1, na.rm = TRUE)/.N,
  prop_noasthma = sum(asthma == 0, na.rm = TRUE)/.N),
  by = "townname"] %>% knitr::kable(caption = "FEV by Town")
```
```{r fev - sex}
##By Sex
merged[, .(
  fev_avg = mean(fev, na.rm = TRUE),
  fev_sd  = sd(fev, na.rm = TRUE),
  prop_asthma = sum(asthma == 1, na.rm = TRUE)/.N,
  prop_noasthma = sum(asthma == 0, na.rm = TRUE)/.N),
  by = "male_ch"] %>% knitr::kable(caption = "FEV by Sex")
```
```{r fev - obesity level}
##By Obesity Level
merged[, .(
  fev_avg = mean(fev, na.rm = TRUE),
  fev_sd  = sd(fev, na.rm = TRUE),
  prop_asthma = sum(asthma == 1, na.rm = TRUE)/.N,
  prop_noasthma = sum(asthma == 0, na.rm = TRUE)/.N),
  by = "obesity_level"] %>% knitr::kable(caption = "FEV by Obesity Level")
```
```{r fev - smokegas}
##By Town
merged[, .(
  fev_avg = mean(fev, na.rm = TRUE),
  fev_sd  = sd(fev, na.rm = TRUE),
  prop_asthma = sum(asthma == 1, na.rm = TRUE)/.N,
  prop_noasthma = sum(asthma == 0, na.rm = TRUE)/.N),
  by = "smoke_gas_exposure"] %>% knitr::kable(caption = "FEV by Smoke & Gas Exposure")

```

## Looking at the Data
The primary questions of interest are: 1. What is the association between BMI and FEV (forced expiratory volume)? 2. What is the association between smoke and gas exposure and FEV? 3. What is the association between PM2.5 exposure and FEV?

### Question 1
#### Facet plot showing scatterplots with regression lines of BMI vs FEV by “townname”.
```{r geom_facet}
ggplot(data = merged, mapping = aes(x = bmi, y = fev)) +
  geom_point(mapping = aes(color = townname), show.legend = FALSE) +
  geom_smooth(method = lm, se = FALSE) +
  facet_wrap( ~ townname) +
  labs(title = "FEV and BMI by Town", y = "Forced Expiratory Volume (FEV) in One Second (mL)", x = "Body Mass Index (BMI)")
```

### Question 2
#### Stacked histograms of FEV by BMI category and FEV by smoke/gas exposure. Use different color schemes than the ggplot default.
```{r hist-fev-bmi}
ggplot(data = merged, mapping=aes(x = fev,fill = obesity_level)) +
  geom_histogram(binwidth = 50, color = 'black') +
  scale_fill_brewer(palette = 'Set2') +
  labs(title = "Histogram of FEV by BMI Category", x = "FEV", y = "Frequency")
```
```{r hist-fev-smokegas}
merged[!is.na(smoke_gas_exposure)] %>%
  ggplot(mapping=aes(x = fev,fill = smoke_gas_exposure)) +
  geom_histogram(binwidth = 50, color = 'black') +
  scale_fill_brewer(palette = 'Set2') +
  labs(title = "Histogram of FEV by Smoke/Gas Exposure Category", x = "FEV", y = "Frequency")
```

### Question 3
#### Barchart of BMI by smoke/gas exposure.
```{r}
merged[!is.na(smoke_gas_exposure)] %>%
  ggplot(mapping = aes(x = obesity_level, fill = smoke_gas_exposure)) +
  geom_bar(position = 'dodge', color = 'black') +
  scale_fill_brewer(palette = "Set2") +
  labs(title = "Bar Plot of BMI Category by Smoke/Gas Exposure", x = "BMI Category", y = "Count")
```



